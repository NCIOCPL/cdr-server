<?xml version="1.0"?>

<xsl:transform           xmlns:xsl = "http://www.w3.org/1999/XSL/Transform"
                         xmlns:cdr = "cips.nci.nih.gov/cdr"
                           version = "1.0"
           exclude-result-prefixes = "cdr">

 <xsl:output                method = "xml" 
              omit-xml-declaration = "no"
                          encoding = "UTF-8"/>

  <!-- ===========================================================
       Root element
       =========================================================== -->
  <xsl:template              match = "/" >
    <xsl:apply-templates    select = "Summary"/>
  </xsl:template>

  <!-- ===========================================================
       Document element.
       =========================================================== -->
  <xsl:template              match = "Summary">

<!-- Creating Document Element and adding Doc ID as attribute
     ======================================================== -->
     <Summary>
     <xsl:attribute           name = "id">
       <xsl:value-of        select = "DocId"/>
     </xsl:attribute>

      <xsl:apply-templates  select = "SummaryMetaData"/>
      <xsl:apply-templates  select = "SummaryTitle"
                            mode   = "copy"/>

<!-- Create the SummarySection elements 
     ================================== -->
      <xsl:apply-templates  select = "SummarySection"/>

      <xsl:apply-templates  select = "TranslationOf"
                            mode   = "copy"/>
      <!--xsl:attribute name = "ref"/-->

      <xsl:apply-templates  select = "DateLastModified"
                            mode   = "copy"/>
      <xsl:apply-templates  select = "DateFirstPublished"
                            mode   = "copy"/>

<!-- Display the Disclaimer based on the entries of 
     Language        - Englisch, Spanish
     SummaryAudience - Patient, HealthProfessional
     SummaryType     - Treatment, CAM, etc...
     EditorialBoard  - Pediatric, Adult  
     ============================================================= -->   
      <ProfessionalDisclaimer>
      ************************************************

        <xsl:choose>
          <xsl:when                      test   = "SummaryMetaData/
                                                   SummaryLanguage='English'">
            <xsl:choose>
             <xsl:when                   test   = "SummaryMetaData/
                                                   SummaryAudience='Patients'">
               Summary: English, Patient, 

               <xsl:choose>
               <!-- Adding english patient treatment document -->
                <xsl:when                test   = "SummaryMetaData/
                                                   SummaryType='Treatment'">
                    Treatment

                  <xsl:choose>
                    <xsl:when              test = "contains(
                                 SummaryMetaData/PDQBoard/Board, 'Pediatric')">
                     Pediatric
                      <xsl:variable        name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000253227')"/>
                    <xsl:apply-templates select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/>
                    </xsl:when>
                    <xsl:otherwise>
                    Adult
                     <xsl:variable         name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                    <xsl:apply-templates select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/>
                    </xsl:otherwise>
                  </xsl:choose>
                </xsl:when>
                <xsl:when                test   = "SummaryMetaData/
                                                   SummaryType='Screening'">
                    Screening
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR00000253233')"/>
                  <xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/> 
                </xsl:when>
                <xsl:when                test   = "SummaryMetaData/
                                                   SummaryType='Prevention'">
                    Prevention
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR00000253232')"/>
                  <xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/> 
                </xsl:when>
                <xsl:when                test   = "SummaryMetaData/
                                                   SummaryType=
                                                   'Supportive care'">
                    Supportive
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR00000253224')"/>
                  <xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/> 
                </xsl:when>
                <xsl:when                test   = "SummaryMetaData/
                                                   SummaryType=
                                      'Complementary and alternative medicine'">
                    CAM
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/> 
                </xsl:when>
                <xsl:when                test   = "SummaryMetaData/
                                                   SummaryType='Genetics'">
                    Genetics
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                   MiscellaneousDocumentText"/> 
                </xsl:when>
               </xsl:choose>
             </xsl:when>
             <xsl:otherwise>
               HP, 
               <xsl:choose>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Treatment'">
                    Treatment
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Screening'">
                    Screening
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Prevention'">
                    Prevention
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Supportive care'">
                    Supportive
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType=
                                      'Complementary and alternative medicine'">
                    CAM
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Genetics'">
                    Genetics
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
               </xsl:choose>
             </xsl:otherwise>
            </xsl:choose>
          </xsl:when>

          <xsl:otherwise>
            <xsl:choose>
             <xsl:when      test   = "SummaryMetaData/
                                      SummaryAudience='Patient'">
               Summary: Spanish, Patient, 
               <xsl:choose>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Treatment'">
                    Treatment
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Screening'">
                    Screening
                    **************** not available yet **************
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Prevention'">
                    Prevention
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Supportive care'">
                    Supportive
                    **************** not available yet **************
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType=
                                      'Complementary and alternative medicine'">
                    CAM
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Genetics'">
                    Genetics
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
               </xsl:choose>


             </xsl:when>
             <xsl:otherwise>
               HP, 
               <xsl:choose>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Treatment'">
                    Treatment
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Screening'">
                    Screening
                    **************** not available yet **************
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Prevention'">
                    Prevention
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Supportive care'">
                    Supportive
                    **************** not available yet **************
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType=
                                      'Complementary and alternative medicine'">
                    CAM
                    **************** not available yet **************
                  <xsl:variable            name = "miscDoc" 
                                         select = "document
                                                   ('cdrx:CDR0000000311')"/>
                  <!-- xsl:apply-templates   select = "$miscDoc/
                                                   MiscellaneousDocument/
                                                 MiscellaneousDocumentText"/--> 
                </xsl:when>
                <xsl:when   test   = "SummaryMetaData/
                                      SummaryType='Genetics'">
                    Genetics
                    **************** not available yet **************
                </xsl:when>
               </xsl:choose>
             </xsl:otherwise>
            </xsl:choose>
          </xsl:otherwise>
        </xsl:choose>
         
      </ProfessionalDisclaimer>
    </Summary>
  </xsl:template>

<!-- ==================================================================
     SummarySection Template
     ================================================================== -->  <xsl:template                    match = "SummarySection">
  <SummarySection>
    <xsl:apply-templates        select = "SectMetaData"/>
    <xsl:apply-templates        select = "Title"/>
    <xsl:apply-templates        select = "AltTitle"
                                mode   = "copy"/>
    <xsl:apply-templates        select = "KeyPoint"/>
    <xsl:apply-templates        select = "Para"/>
    <xsl:apply-templates        select = "SummarySection"/>


<!-- Create the Reference Section of the summary section
     =================================================== -->
    <xsl:if                       test = "ReferenceList">
      <ReferenceSection>
        <xsl:for-each           select = "ReferenceList/Reference">
          <Citation>
          <xsl:attribute          name = "id">
            <xsl:value-of       select = "./@refidx"/>
          </xsl:attribute>
          <xsl:if                 test = "./@PMID">
            <xsl:attribute        name = "PMID">
              <xsl:value-of     select = "./@PMID"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:if                 test = "./@MedlineID">
            <xsl:attribute        name = "MedlineID">
              <xsl:value-of     select = "./@MedlineID"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:if                 test = "./@CancerLitID">
            <xsl:attribute        name = "CancerlitID">
              <xsl:value-of     select = "./@CancerLitID"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:if                 test = "./@ProtocolID">
            <xsl:attribute        name = "ProtocolID">
              <xsl:value-of     select = "./@ProtocolID"/>
            </xsl:attribute>
          </xsl:if>
          <xsl:value-of         select = "."/>
          <!-- xsl:attribute name = "id"/-->
          </Citation>
        </xsl:for-each>
      </ReferenceSection>
    </xsl:if>
  </SummarySection>
</xsl:template>



<!-- ==================================================================
     MiscellaneousDocumentText Template
     ================================================================== -->  <xsl:template                    match = "MiscellaneousDocumentText">
  <Section>
    <xsl:apply-templates        select = "Title"/>
    <xsl:apply-templates        select = "Para"/>
    <xsl:apply-templates        select = "Section"/>
  </Section>
</xsl:template>



<!-- ==================================================================
     SummaryMetaData Template
     ================================================================== -->  <xsl:template                match = "SummaryMetaData">
  <SummaryMetaData>
    <xsl:apply-templates        select = "SummaryType"
                                mode   = "copy"/>
    <xsl:apply-templates        select = "SummaryAudience"
                                mode   = "copy"/>
    <xsl:apply-templates        select = "SummaryLanguage"
                                mode   = "copy"/>
    <xsl:apply-templates        select = "MainTopics"/>
    <xsl:apply-templates        select = "SecondaryTopics"/>
  </SummaryMetaData>
</xsl:template>



<!-- ==================================================================
     SectMetaData Template
     ================================================================== -->  <xsl:template                match = "SectMetaData">
  <SectMetaData>
    <xsl:if                       test = "Diagnosis">
      <SpecificDiagnosis>
        <xsl:value-of             select = "Diagnosis"/>
      </SpecificDiagnosis>
    </xsl:if>
    <xsl:apply-templates        select = "SectionType"
                                mode   = "copy"/>
  </SectMetaData>
</xsl:template>



<!-- ============================================================= 
     Create the Para template including the renamed attribute for 
     the paragraph IDs. (cdr:ref ID needs to be renamed to id).
     ============================================================= -->
  <xsl:template              match = "Para">
    <Para>
      <xsl:attribute          name = "id">
        <xsl:value-of       select = "./@cdr:id"/>
      </xsl:attribute>
      <xsl:apply-templates/>
      <!-- xsl:value-of         select = "."/ -->
    </Para>
  </xsl:template>
    

<!-- ============================================================= 
     Create the Title template 
     ============================================================= -->
  <xsl:template              match = "Title   | AltTitle">
    <xsl:copy>
      <xsl:apply-templates/>
    </xsl:copy>
  </xsl:template>
    

<!-- ============================================================= 
     Create the KeyPoint template including the renamed attribute for 
     the paragraph IDs. (cdr:ref ID needs to be renamed to id).
     ============================================================= -->
  <xsl:template              match = "KeyPoint">
    <KeyPoint>
      <xsl:attribute          name = "id">
        <xsl:value-of       select = "./@cdr:id"/>
      </xsl:attribute>
      <xsl:apply-templates/>
      <!-- xsl:value-of         select = "."/ -->
    </KeyPoint>
  </xsl:template>
    

<!-- ============================================================= 
     Create the Para template including the renamed attribute for 
     the paragraph IDs. (cdr:ref ID needs to be renamed to id).
     ============================================================= -->
  <xsl:template              match = "MainTopics">
    <MainTopics>
     <TermRef>
      <xsl:attribute          name = "ref">
        <xsl:value-of       select = "Term/@cdr:ref"/>
      </xsl:attribute>
      <xsl:apply-templates/>
     </TermRef>
    </MainTopics>
  </xsl:template>
    

<!-- ============================================================= 
     Create the Para template including the renamed attribute for 
     the paragraph IDs. (cdr:ref ID needs to be renamed to id).
     ============================================================= -->
  <xsl:template              match = "SecondaryTopics">
    <SecondaryTopics>
     <TermRef>
      <xsl:attribute          name = "ref">
        <xsl:value-of       select = "Term/@cdr:ref"/>
      </xsl:attribute>
      <xsl:apply-templates/>
     </TermRef>
    </SecondaryTopics>
  </xsl:template>
    

<!-- ============================================================= 
     Create the CitationLink template including the renamed attribute 
     for the Citation ref (cdr:ref ID needs to be renamed to ref).
     ============================================================= -->
  <xsl:template              match = "CitationLink">
    <Reference>
      <!-- xsl:attribute          name = "ref">
        <xsl:value-of       select = "./@cdr:ref"/>
      </xsl:attribute-->
      <xsl:attribute          name = "ref">
        <xsl:value-of       select = "./@refidx"/>
      </xsl:attribute>
      <xsl:value-of         select = "."/>
    </Reference>
  </xsl:template>


<!-- ================================================================ 
     Template rule used to do XML to XML transformations which
     copies any attribute node, or node that is child of of something 
     ================================================================ -->
 <xsl:template               match = "@*|node()"
                              mode = "copy">
  <xsl:copy>
   <xsl:apply-templates     select = "@*" 
                              mode = "copy"/>
   <xsl:apply-templates       mode = "copy"/>
  </xsl:copy>
 </xsl:template>

</xsl:transform>
