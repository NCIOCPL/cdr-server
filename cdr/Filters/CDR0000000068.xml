<?xml version="1.0"?>
  <xsl:transform xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                 version="1.0"
                 xmlns:cdr="cips.nci.nih.gov/cdr">
   <xsl:output method="text"/>

<xsl:template match="Person">
   <xsl:apply-templates select="PersonNameInformation/GivenName"/>;<xsl:text/>
   <xsl:apply-templates select="PersonNameInformation/SurName"/>;<xsl:text/>
   <xsl:for-each select="PersonLocations">
    <xsl:variable name="Cipscontact" select="CIPSContact"/>
    <xsl:if test="OtherPracticeLocation[@cdr:id=$Cipscontact]">
     <xsl:value-of select="OtherPracticeLocation/SpecificContact/PostalAddress/City"/>;<xsl:text/>
     <xsl:choose>
    <xsl:when test="contains(OtherPracticeLocation/SpecificContact/PostalAddress/PoliticalUnit_State/@cdr:ref,'CDR')">
   <xsl:variable name="StateID" select="OtherPracticeLocation/SpecificContact/PostalAddress/PoliticalUnit_State/@cdr:ref"/>
    <xsl:variable name="StateInfo" select="document(concat('cdr:',$StateID))"/>
    <xsl:if test="$StateInfo/State/StateName">
    <xsl:apply-templates select="$StateInfo/State/StateName"/>
    </xsl:if>
   </xsl:when>
   <xsl:otherwise>
   <xsl:value-of select="$StateID"/>
    <xsl:text>not available in database</xsl:text>
    </xsl:otherwise>
    </xsl:choose>
    </xsl:if>
   </xsl:for-each>  
   </xsl:template>
  </xsl:transform>