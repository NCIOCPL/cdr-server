<CdrDoc Type='Filter' Id='CDR0000000111'>
<CdrDocCtl>
<DocValStatus readonly="yes">U</DocValStatus>
<DocActiveStatus readonly="yes">A</DocActiveStatus>
<DocTitle readonly="yes">Global Change: Organization Link</DocTitle>
<ReadyForReview readonly="yes">N</ReadyForReview>
</CdrDocCtl>
<CdrDocXml><![CDATA[<?xml version="1.0"?>

<!--myTitle>  Creator:  Volker Englisch
              Created:  06/20/2002</myTitle-->

<!-- 
 ==================================================================
 Change an site link from one organization to another in a protcol.
 
 $Id: CDR0000000111.xml,v 1.7 2005-08-18 21:58:15 ameyer Exp $

 $Log: not supported by cvs2svn $
 ================================================================== -->
<xsl:transform              xmlns:xsl = "http://www.w3.org/1999/XSL/Transform"
                            xmlns:cdr = "cips.nci.nih.gov/cdr"
                              version = "1.0">

 <xsl:output                   method = "xml" 
                 omit-xml-declaration = "no"/>

 <!--
 ================================================================
 Passed in by the caller.
 ================================================================ -->
 <xsl:param                      name = "changeFrom"/>
 <xsl:param                      name = "changeTo"/>
 <xsl:param                      name = "today"/>


 <!--
 ================================================================
 Default rule, copying back out everything just as we got it.
 ================================================================ -->
 <xsl:template                  match = "@*|comment()|*|
                                         processing-instruction()|text()">
  <xsl:copy>
   <xsl:apply-templates        select = "@*|comment()|*|
                                         processing-instruction()|text()"/>
  </xsl:copy>
 </xsl:template>

 <!--
 ===================================================================
 Template to change the Organization link
 There are four possible options for changing an Organization link:
 a)  Value in Document 11111
     changeFrom        11111
     ==> change to 22222 or 22222#F2 depending on user entry
 b)  Value in Document 11111#F1
     changeFrom        11111
     ==> change to 22222 or 22222#F2 depending on user entry
 c)  Value in Document 11111
     changeFrom        11111#F1
     ==> no change will be done. If the user specified the fragment
         specifically it has to be assumed that this fragment exists
 d)  Value in Document 11111#F1
     changeFrom        11111#F1
     ==> change to 22222 or 22222#F2 depending on user entry

 =================================================================== -->
 <xsl:template                  match = "/InScopeProtocol/ProtocolAdminInfo
                                         /ProtocolLeadOrg/ProtocolSites
                                         /OrgSite/OrgSiteID
                                         |
                                         /InScopeProtocol/ProtocolAdminInfo
                                         /ProtocolLeadOrg/ProtocolSites
                                         /PrivatePracticeSite
                                         /PrivatePracticeSiteID">
  <xsl:choose>
   <!-- Changing Organization link based on option (d) -->
   <xsl:when                     test = "contains(@cdr:ref, '#') and
                                         contains($changeFrom, '#') and
                                         @cdr:ref=$changeFrom">
    <OrgSiteID>
     <xsl:attribute              name = "cdr:ref">
      <xsl:value-of            select = "$changeTo"/>
     </xsl:attribute>
    </OrgSiteID>
   </xsl:when>

   <!-- Changing Organization link based on option (b) -->
   <xsl:when                      test = "contains(@cdr:ref, '#') and
                                          not(contains($changeFrom, '#')) and
                                          substring-before(@cdr:ref, '#')
                                          =$changeFrom">
    <OrgSiteID>
     <xsl:attribute              name = "cdr:ref">
      <xsl:value-of            select = "$changeTo"/>
     </xsl:attribute>
    </OrgSiteID>
   </xsl:when>

   <!-- Changing Organization link based on option (d) -->
   <xsl:when                     test = "not(contains(@cdr:ref, '#')) and
                                         not(contains($changeFrom, '#')) and
                                         @cdr:ref=$changeFrom">
    <OrgSiteID>
     <xsl:attribute              name = "cdr:ref">
      <xsl:value-of            select = "$changeTo"/>
     </xsl:attribute>
    </OrgSiteID>
   </xsl:when>

   <!-- All other nodes will be put out as is -->
   <xsl:otherwise>
    <xsl:copy>
     <xsl:apply-templates      select = "@*|comment()|*|
                                         processing-instruction()|text()"/>
    </xsl:copy>
   </xsl:otherwise>
  </xsl:choose>

 </xsl:template>

 <!--
 ================================================================
 Update DateLastModified to be today's date.
 Note: Users decided not to do this for this global change type.
       Am leaving this code in place, with unused passed "$today"
       parameter in case we ever need it.
       But it's all commented out.

 <xsl:template               match = "DateLastModified">
   <xsl:element               name = "DateLastModified">
     <xsl:value-of          select = "$today"/>
   </xsl:element>
 </xsl:template>
 ================================================================ -->

</xsl:transform>
]]>
</CdrDocXml>
</CdrDoc>