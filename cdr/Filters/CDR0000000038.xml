<CdrDoc Type='Filter' Id='CDR0000000038'>
<CdrDocCtl>
<DocValStatus readonly="yes">U</DocValStatus>
<DocActiveStatus readonly="yes">A</DocActiveStatus>
<DocTitle readonly="yes">[OBSOLETE] Filter for Summary Mailers</DocTitle>
</CdrDocCtl>
<CdrDocXml><![CDATA[<?xml version='1.0' encoding='UTF-8'?>

<xsl:transform xmlns:xsl = "http://www.w3.org/1999/XSL/Transform"
               version   = "1.0"
               xmlns:cdr = "cips.nci.nih.gov/cdr">
 <xsl:output method="xml"/>

 <!-- Testing the filter fix! -->

 <!-- Pass through everything by default -->
 <xsl:template match = '@*|node()'>
  <xsl:copy>
   <xsl:apply-templates select="@*"/>
   <xsl:apply-templates/>
  </xsl:copy>
 </xsl:template>

 <!-- Expand citation references -->
 <xsl:template match="CitationReference">
  <xsl:choose>

   <!-- Check to make sure the citation key has been resolved to a CDR ID. -->
   <xsl:when test='string-length(@cdr:ref) > 3'>
    <xsl:variable name='cdrId' select='@cdr:ref'/>
    <xsl:variable name='citation' select="document(concat('cdrx:', $cdrId))"/>
    <xsl:choose>
     <xsl:when test='$citation//NotFound'>
      <Footnote>Citation <xsl:value-of select='@cdr:ref'/> missing.</Footnote>
     </xsl:when>

     <!-- Non-PubMed citation -->
     <xsl:when test='$citation//CitationTitle'>
      <xsl:variable name='authors' select='normalize-space($citation//AuthorList)'/>
      <xsl:variable name='title' select='normalize-space($citation//CitationTitle)'/>
      <xsl:variable name='info' select='normalize-space($citation//OtherPublicationInformation)'/>
      <Footnote><xsl:if test='$authors'><xsl:value-of select='$authors'/><xsl:text>: </xsl:text></xsl:if><xsl:value-of select='$title'/><xsl:if test='$info'><xsl:text> </xsl:text><xsl:value-of select='$info'/></xsl:if></Footnote>
     </xsl:when>

     <!-- Citation is from PubMed -->
     <xsl:when test='$citation//ArticleTitle'>
      <Footnote><xsl:for-each select='$citation//AuthorList/Author'><xsl:if test='position()>1'>, </xsl:if><xsl:value-of select='Initials'/><xsl:text> </xsl:text><xsl:value-of select='LastName'/></xsl:for-each>.  <xsl:value-of select='$citation//ArticleTitle'/><xsl:text> </xsl:text><xsl:value-of select='$citation//MedlineTA'/><xsl:text> </xsl:text><xsl:value-of select='$citation//Volume'/>(<xsl:value-of select='$citation//Issue'/>): <xsl:value-of select='$citation//MedlinePgn'/>, <xsl:value-of select='$citation//PubDate/Year'/>.</Footnote>
     </xsl:when>

     <!-- Can't find any recognizable citation structure. -->
     <xsl:otherwise>
      <FOOTNOTE>UNRECOGNIZED CITATION STRUCTURE!</FOOTNOTE>
     </xsl:otherwise>
    </xsl:choose>
   </xsl:when>
   <xsl:otherwise>
    <Footnote>Unresolved footnote for PDQ <xsl:value-of select='@PdqKey'/>.</Footnote>
   </xsl:otherwise>
  </xsl:choose>
 </xsl:template>

</xsl:transform>
]]>
</CdrDocXml>
</CdrDoc>