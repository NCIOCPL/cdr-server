<?xml version = "1.0" encoding="utf-8"?>
<!-- $Id$ -->
<!-- Filter title: Denormalization Filter: GlossaryTermName -->
<!--
 ================================================================
 $Id$

 Filter to denormalize summary data.
 Written by Volker Englisch, 2004-11-09

BZIssue::5115 - Images Missing from GlossaryTerms
OCECDR-3528: Ability to put links to other Dictionary terms in More 
             Information block on Cancer.gov

 ================================================================ -->
<xsl:transform               xmlns:xsl = "http://www.w3.org/1999/XSL/Transform"
                               version = "1.0"
                             xmlns:cdr = "cips.nci.nih.gov/cdr">

 <xsl:output                    method = "xml" 
                  omit-xml-declaration = "no"/>

 <!-- 
 =================================================================
 Copy control information and generate current date
 ================================================================= -->
 <xsl:template                   match = "GlossaryTermName">
  <xsl:copy>
   <xsl:apply-templates/>
  </xsl:copy>
 </xsl:template>


 <!--
 =================================================================
 Denormalize the GlossaryTermConcept information
 ================================================================= -->
 <xsl:template                   match = "GlossaryTermConcept">
  <xsl:variable                   name = "conceptId"
                                select = "@cdr:ref"/>

  <xsl:variable                   name = "concept"
                                select = "document(concat('cdr:', $conceptId,
                                                          '/last'))"/>
  <!-- xsl:element                    name = "GlossaryTermConcept">
   <xsl:attribute                 name = "cdr:ref">
    <xsl:value-of               select = "$conceptId"/>
   </xsl:attribute>
   <xsl:copy-of                 select = "$concept/
                                          GlossaryTermConcept/*"/>
  </xsl:element -->
  <xsl:element                    name = "GlossaryTermConcept">
   <xsl:attribute                 name = "cdr:ref">
    <xsl:value-of               select = "$conceptId"/>
   </xsl:attribute>
   <xsl:copy-of                 select = "$concept/
                                            GlossaryTermConcept/
                                            TermDefinition"/>
   <xsl:copy-of                 select = "$concept/
                                            GlossaryTermConcept/
                                            MediaLink"/>
   <xsl:copy-of                 select = "$concept/
                                            GlossaryTermConcept/
                                            TranslatedTermDefinition"/>
   <xsl:copy-of                 select = "$concept/
                                            GlossaryTermConcept/
                                            TermType"/>
   <xsl:apply-templates         select = "$concept/
                                            GlossaryTermConcept/
                                            RelatedInformation"/>
  </xsl:element>
 </xsl:template>


 <!--
 =================================================================
 Denormalize the GlossaryTermConcept information
 ================================================================= -->
 <xsl:template                   match = "RelatedInformation">
  <xsl:copy>
   <xsl:apply-templates         select = "RelatedDrugSummaryLink  |
                                          RelatedSummaryRef       |
                                          RelatedExternalRef      |
                                          RelatedGlossaryTermNameLink"/>
  </xsl:copy>
 </xsl:template>


 <!--
 =================================================================
 Denormalize the GlossaryTermConcept information
 ================================================================= -->
 <xsl:template                   match = "RelatedSummaryRef">
  <xsl:variable                   name = "relatedId"
                                select = "@cdr:ref"/>

  <xsl:variable                   name = "related"
                                select = "document(concat('cdr:', $relatedId,
                                                          '/lastp'))"/>
  <xsl:element                    name = "{name()}">
   <xsl:for-each                select = "@*">
    <xsl:attribute                name = "{name()}">
     <xsl:value-of              select = "."/>
    </xsl:attribute>
   </xsl:for-each>
  <xsl:element                    name = "Summary">
   <xsl:copy-of                 select = "$related/Summary/
                                            SummaryMetaData"/>
   <xsl:copy-of                 select = "$related/Summary/
                                            SummaryTitle"/>
  </xsl:element>
  </xsl:element>
 </xsl:template>


 <!--
 =================================================================
 Denormalize the GlossaryTermConcept information
 ================================================================= -->
 <xsl:template                   match = "RelatedDrugSummaryLink">
  <xsl:variable                   name = "relatedId"
                                select = "@cdr:ref"/>

  <xsl:variable                   name = "related"
                                select = "document(concat('cdr:', $relatedId,
                                                          '/lastp'))"/>
  <xsl:element                    name = "{name()}">
   <xsl:for-each                select = "@*">
    <xsl:attribute                name = "{name()}">
     <xsl:value-of              select = "."/>
    </xsl:attribute>
   </xsl:for-each>
  <xsl:element                    name = "DrugInformationSummary">
   <xsl:copy-of                 select = "$related/DrugInformationSummary/
                                            DrugInfoMetaData"/>
   <xsl:copy-of                 select = "$related/DrugInformationSummary/
                                            Title"/>
  </xsl:element>
  </xsl:element>
 </xsl:template>


 <!-- 
 ==================================================================
 Template rule used to do XML to XML transformations which
 copies any attribute node, or node that is child of of something 
 ================================================================== -->
 <xsl:template                   match = "@*|node()">
  <xsl:copy>
   <xsl:apply-templates         select = "@*|node()"/>
  </xsl:copy> 
 </xsl:template>
</xsl:transform>
